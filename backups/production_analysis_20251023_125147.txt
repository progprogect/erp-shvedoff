=== BACKING UP PRODUCTION DATABASE ===
Starting backup at:  Thu Oct 23 12:51:48 +03 2025
=== SCHEMA DUMP ===
                    ?column?                    
------------------------------------------------
 TABLE: audit_log
 TABLE: bottom_types
 TABLE: carpet_edge_types
 TABLE: categories
 TABLE: cutting_operations
 TABLE: cutting_progress_log
 TABLE: defect_products
 TABLE: operation_reversals
 TABLE: order_items
 TABLE: order_messages
 TABLE: orders
 TABLE: permissions
 TABLE: product_logos
 TABLE: product_materials
 TABLE: product_relations
 TABLE: product_surfaces
 TABLE: production_queue
 TABLE: production_task_extras
 TABLE: production_tasks
 TABLE: production_tasks_backup_20251002_095833
 TABLE: products
 TABLE: products_backup_20251002_095833
 TABLE: products_bottom_type_fix_backup
 TABLE: products_carpet_edge_backup
 TABLE: puzzle_types
 TABLE: role_permissions
 TABLE: roll_covering_composition
 TABLE: shipment_items
 TABLE: shipment_orders
 TABLE: shipments
 TABLE: stock
 TABLE: stock_movements
 TABLE: telegram_notifications
 TABLE: user_permissions
 TABLE: users
(35 rows)

=== CHECKING LIBERTY GRADE COLUMNS ===
 table_name | column_name | data_type 
------------+-------------+-----------
(0 rows)

=== CHECKING SECOND GRADE COLUMNS ===
      table_name      |         column_name          | data_type 
----------------------+------------------------------+-----------
 cutting_operations   | actual_second_grade_quantity | integer
 cutting_progress_log | second_grade_quantity        | integer
(2 rows)

=== CHECKING TRIGGER FUNCTIONS ===
            function_name             |                                                                                            definition                                                                                            
--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 get_cutting_operation_progress       | CREATE OR REPLACE FUNCTION public.get_cutting_operation_progress(operation_id_param integer)                                                                                                    +
                                      |  RETURNS TABLE(total_product_quantity integer, total_second_grade_quantity integer, total_waste_quantity integer, last_updated timestamp without time zone)                                     +
                                      |  LANGUAGE plpgsql                                                                                                                                                                               +
                                      | AS $function$                                                                                                                                                                                   +
                                      | BEGIN                                                                                                                                                                                           +
                                      |     RETURN QUERY                                                                                                                                                                                +
                                      |     SELECT                                                                                                                                                                                      +
                                      |         COALESCE(SUM(cpl.product_quantity), 0)::INTEGER as total_product_quantity,                                                                                                              +
                                      |         COALESCE(SUM(cpl.second_grade_quantity), 0)::INTEGER as total_second_grade_quantity,                                                                                                    +
                                      |         COALESCE(SUM(cpl.waste_quantity), 0)::INTEGER as total_waste_quantity,                                                                                                                  +
                                      |         MAX(cpl.entered_at) as last_updated                                                                                                                                                     +
                                      |     FROM cutting_progress_log cpl                                                                                                                                                               +
                                      |     WHERE cpl.operation_id = operation_id_param;                                                                                                                                                +
                                      | END;                                                                                                                                                                                            +
                                      | $function$                                                                                                                                                                                      +
                                      | 
 update_cutting_operation_on_progress | CREATE OR REPLACE FUNCTION public.update_cutting_operation_on_progress()                                                                                                                        +
                                      |  RETURNS trigger                                                                                                                                                                                +
                                      |  LANGUAGE plpgsql                                                                                                                                                                               +
                                      | AS $function$                                                                                                                                                                                   +
                                      | BEGIN                                                                                                                                                                                           +
                                      |     -- Просто возвращаем NEW без обновления updated_at, так как этой колонки нет в cutting_operations                                                                                           +
                                      |     -- В будущем можно добавить колонку updated_at в таблицу cutting_operations если потребуется                                                                                                +
                                      |     RETURN NEW;                                                                                                                                                                                 +
                                      | END;                                                                                                                                                                                            +
                                      | $function$                                                                                                                                                                                      +
                                      | 
 validate_cutting_progress            | CREATE OR REPLACE FUNCTION public.validate_cutting_progress()                                                                                                                                   +
                                      |  RETURNS trigger                                                                                                                                                                                +
                                      |  LANGUAGE plpgsql                                                                                                                                                                               +
                                      | AS $function$                                                                                                                                                                                   +
                                      | DECLARE                                                                                                                                                                                         +
                                      |     operation_status TEXT;                                                                                                                                                                      +
                                      | BEGIN                                                                                                                                                                                           +
                                      |     -- Получаем статус операции                                                                                                                                                                 +
                                      |     SELECT status INTO operation_status                                                                                                                                                         +
                                      |     FROM cutting_operations                                                                                                                                                                     +
                                      |     WHERE id = NEW.operation_id;                                                                                                                                                                +
                                      |                                                                                                                                                                                                 +
                                      |     -- Проверяем, что операция не завершена                                                                                                                                                     +
                                      |     IF operation_status = 'completed' THEN                                                                                                                                                      +
                                      |         RAISE EXCEPTION 'Нельзя добавлять прогресс для завершенной операции резки';                                                                                                             +
                                      |     END IF;                                                                                                                                                                                     +
                                      |                                                                                                                                                                                                 +
                                      |     RETURN NEW;                                                                                                                                                                                 +
                                      | END;                                                                                                                                                                                            +
                                      | $function$                                                                                                                                                                                      +
                                      | 
 update_stock_from_cutting_progress   | CREATE OR REPLACE FUNCTION public.update_stock_from_cutting_progress()                                                                                                                          +
                                      |  RETURNS trigger                                                                                                                                                                                +
                                      |  LANGUAGE plpgsql                                                                                                                                                                               +
                                      | AS $function$                                                                                                                                                                                   +
                                      | DECLARE                                                                                                                                                                                         +
                                      |     _source_product_id INTEGER;                                                                                                                                                                 +
                                      |     _target_product_id INTEGER;                                                                                                                                                                 +
                                      |     _second_grade_product_id INTEGER;                                                                                                                                                           +
                                      |     _target_product_name VARCHAR;                                                                                                                                                               +
                                      |     _product_diff INTEGER;                                                                                                                                                                      +
                                      |     _second_grade_diff INTEGER;                                                                                                                                                                 +
                                      |     _waste_diff INTEGER;                                                                                                                                                                        +
                                      |     _total_produced_diff INTEGER;                                                                                                                                                               +
                                      |     _source_quantity INTEGER;                                                                                                                                                                   +
                                      |     _user_id INTEGER;                                                                                                                                                                           +
                                      | BEGIN                                                                                                                                                                                           +
                                      |     -- Получаем информацию об операции резки                                                                                                                                                    +
                                      |     SELECT co.source_product_id, co.target_product_id, co.source_quantity, co.operator_id, p.name                                                                                               +
                                      |     INTO _source_product_id, _target_product_id, _source_quantity, _user_id, _target_product_name                                                                                               +
                                      |     FROM cutting_operations co                                                                                                                                                                  +
                                      |     LEFT JOIN products p ON p.id = co.target_product_id                                                                                                                                         +
                                      |     WHERE co.id = NEW.operation_id;                                                                                                                                                             +
                                      |                                                                                                                                                                                                 +
                                      |     -- Определяем ID товара 2-го сорта (если он существует)                                                                                                                                     +
                                      |     SELECT p.id INTO _second_grade_product_id                                                                                                                                                   +
                                      |     FROM products p                                                                                                                                                                             +
                                      |     WHERE p.name = _target_product_name AND p.grade = 'grade_2' AND p.is_active = TRUE;                                                                                                         +
                                      |                                                                                                                                                                                                 +
                                      |     -- Вычисляем разность для обновления остатков                                                                                                                                               +
                                      |     IF TG_OP = 'INSERT' THEN                                                                                                                                                                    +
                                      |         _product_diff := NEW.product_quantity;                                                                                                                                                  +
                                      |         _second_grade_diff := NEW.second_grade_quantity;                                                                                                                                        +
                                      |         _waste_diff := NEW.waste_quantity;                                                                                                                                                      +
                                      |     ELSIF TG_OP = 'UPDATE' THEN                                                                                                                                                                 +
                                      |         _product_diff := NEW.product_quantity - OLD.product_quantity;                                                                                                                           +
                                      |         _second_grade_diff := NEW.second_grade_quantity - OLD.second_grade_quantity;                                                                                                            +
                                      |         _waste_diff := NEW.waste_quantity - OLD.waste_quantity;                                                                                                                                 +
                                      |     ELSE -- DELETE                                                                                                                                                                              +
                                      |         _product_diff := -OLD.product_quantity;                                                                                                                                                 +
                                      |         _second_grade_diff := -OLD.second_grade_quantity;                                                                                                                                       +
                                      |         _waste_diff := -OLD.waste_quantity;                                                                                                                                                     +
                                      |     END IF;                                                                                                                                                                                     +
                                      |                                                                                                                                                                                                 +
                                      |     -- Вычисляем общее количество произведенного товара (готовый + 2 сорт + брак)                                                                                                               +
                                      |     _total_produced_diff := _product_diff + _second_grade_diff + _waste_diff;                                                                                                                   +
                                      |                                                                                                                                                                                                 +
                                      |     -- Списываем исходный товар пропорционально произведенному количеству                                                                                                                       +
                                      |     IF _total_produced_diff != 0 THEN                                                                                                                                                           +
                                      |         UPDATE stock                                                                                                                                                                            +
                                      |         SET                                                                                                                                                                                     +
                                      |             current_stock = current_stock - _total_produced_diff,                                                                                                                               +
                                      |             updated_at = NOW()                                                                                                                                                                  +
                                      |         WHERE product_id = _source_product_id;                                                                                                                                                  +
                                      |                                                                                                                                                                                                 +
                                      |         -- Логируем списание исходного товара                                                                                                                                                   +
                                      |         INSERT INTO stock_movements (                                                                                                                                                           +
                                      |             product_id,                                                                                                                                                                         +
                                      |             movement_type,                                                                                                                                                                      +
                                      |             quantity,                                                                                                                                                                           +
                                      |             reference_id,                                                                                                                                                                       +
                                      |             reference_type,                                                                                                                                                                     +
                                      |             comment,                                                                                                                                                                            +
                                      |             user_id                                                                                                                                                                             +
                                      |         ) VALUES (                                                                                                                                                                              +
                                      |             _source_product_id,                                                                                                                                                                 +
                                      |             'cutting_out'::movement_type,                                                                                                                                                       +
                                      |             ABS(_total_produced_diff),                                                                                                                                                          +
                                      |             NEW.operation_id,                                                                                                                                                                   +
                                      |             'cutting_progress',                                                                                                                                                                 +
                                      |             'Списание исходного товара по операции резки #' || NEW.operation_id || ' (прогресс: товар=' || _product_diff || ', 2сорт=' || _second_grade_diff || ', брак=' || _waste_diff || ')',+
                                      |             _user_id                                                                                                                                                                            +
                                      |         );                                                                                                                                                                                      +
                                      |     END IF;                                                                                                                                                                                     +
                                      |                                                                                                                                                                                                 +
                                      |     -- Обновляем остатки для готового товара                                                                                                                                                    +
                                      |     IF _product_diff != 0 THEN                                                                                                                                                                  +
                                      |         UPDATE stock                                                                                                                                                                            +
                                      |         SET                                                                                                                                                                                     +
                                      |             current_stock = current_stock + _product_diff,                                                                                                                                      +
                                      |             updated_at = NOW()                                                                                                                                                                  +
                                      |         WHERE product_id = _target_product_id;                                                                                                                                                  +
                                      |                                                                                                                                                                                                 +
                                      |         -- Логируем движение товара                                                                                                                                                             +
                                      |         INSERT INTO stock_movements (                                                                                                                                                           +
                                      |             product_id,                                                                                                                                                                         +
                                      |             movement_type,                                                                                                                                                                      +
                                      |             quantity,                                                                                                                                                                           +
                                      |             reference_id,                                                                                                                                                                       +
                                      |             reference_type,                                                                                                                                                                     +
                                      |             comment,                                                                                                                                                                            +
                                      |             user_id                                                                                                                                                                             +
                                      |         ) VALUES (                                                                                                                                                                              +
                                      |             _target_product_id,                                                                                                                                                                 +
                                      |             (CASE WHEN _product_diff > 0 THEN 'cutting_in' ELSE 'outgoing' END)::movement_type,                                                                                                 +
                                      |             ABS(_product_diff),                                                                                                                                                                 +
                                      |             NEW.operation_id,                                                                                                                                                                   +
                                      |             'cutting_progress',                                                                                                                                                                 +
                                      |             'Корректировка готового товара по операции резки #' || NEW.operation_id || ' (прогресс)',                                                                                           +
                                      |             _user_id                                                                                                                                                                            +
                                      |         );                                                                                                                                                                                      +
                                      |     END IF;                                                                                                                                                                                     +
                                      |                                                                                                                                                                                                 +
                                      |     -- Обновляем остатки для товара 2-го сорта                                                                                                                                                  +
                                      |     IF _second_grade_diff != 0 THEN                                                                                                                                                             +
                                      |         -- Если товара 2-го сорта нет, создаем его                                                                                                                                              +
                                      |         IF _second_grade_product_id IS NULL THEN                                                                                                                                                +
                                      |             INSERT INTO products (                                                                                                                                                              +
                                      |                 name,                                                                                                                                                                           +
                                      |                 article,                                                                                                                                                                        +
                                      |                 category_id,                                                                                                                                                                    +
                                      |                 product_type,                                                                                                                                                                   +
                                      |                 grade,                                                                                                                                                                          +
                                      |                 is_active,                                                                                                                                                                      +
                                      |                 notes                                                                                                                                                                           +
                                      |             ) VALUES (                                                                                                                                                                          +
                                      |                 _target_product_name,                                                                                                                                                           +
                                      |                 '2S-' || _target_product_name,                                                                                                                                                  +
                                      |                 (SELECT category_id FROM products WHERE id = _target_product_id),                                                                                                               +
                                      |                 (SELECT product_type FROM products WHERE id = _target_product_id),                                                                                                              +
                                      |                 'grade_2',                                                                                                                                                                      +
                                      |                 TRUE,                                                                                                                                                                           +
                                      |                 'Автоматически создан для 2-го сорта по операции резки #' || NEW.operation_id                                                                                                   +
                                      |             ) RETURNING id INTO _second_grade_product_id;                                                                                                                                       +
                                      |                                                                                                                                                                                                 +
                                      |             -- Создаем запись остатков для нового товара                                                                                                                                        +
                                      |             INSERT INTO stock (product_id, current_stock, reserved_stock)                                                                                                                       +
                                      |             VALUES (_second_grade_product_id, 0, 0);                                                                                                                                            +
                                      |         END IF;                                                                                                                                                                                 +
                                      |                                                                                                                                                                                                 +
                                      |         UPDATE stock                                                                                                                                                                            +
                                      |         SET                                                                                                                                                                                     +
                                      |             current_stock = current_stock + _second_grade_diff,                                                                                                                                 +
                                      |             updated_at = NOW()                                                                                                                                                                  +
                                      |         WHERE product_id = _second_grade_product_id;                                                                                                                                            +
                                      |                                                                                                                                                                                                 +
                                      |         -- Логируем движение товара 2-го сорта                                                                                                                                                  +
                                      |         INSERT INTO stock_movements (                                                                                                                                                           +
                                      |             product_id,                                                                                                                                                                         +
                                      |             movement_type,                                                                                                                                                                      +
                                      |             quantity,                                                                                                                                                                           +
                                      |             reference_id,                                                                                                                                                                       +
                                      |             reference_type,                                                                                                                                                                     +
                                      |             comment,                                                                                                                                                                            +
                                      |             user_id                                                                                                                                                                             +
                                      |         ) VALUES (                                                                                                                                                                              +
                                      |             _second_grade_product_id,                                                                                                                                                           +
                                      |             (CASE WHEN _second_grade_diff > 0 THEN 'cutting_in' ELSE 'outgoing' END)::movement_type,                                                                                            +
                                      |             ABS(_second_grade_diff),                                                                                                                                                            +
                                      |             NEW.operation_id,                                                                                                                                                                   +
                                      |             'cutting_progress',                                                                                                                                                                 +
                                      |             'Корректировка 2-го сорта по операции резки #' || NEW.operation_id || ' (прогресс)',                                                                                                +
                                      |             _user_id                                                                                                                                                                            +
                                      |         );                                                                                                                                                                                      +
                                      |     END IF;                                                                                                                                                                                     +
                                      |                                                                                                                                                                                                 +
                                      |     RETURN NEW;                                                                                                                                                                                 +
                                      | END;                                                                                                                                                                                            +
                                      | $function$                                                                                                                                                                                      +
                                      | 
(4 rows)

=== TABLE COUNTS ===
       ?column?        
-----------------------
 cutting_operations: 7
(1 row)

        ?column?         
-------------------------
 cutting_progress_log: 3
(1 row)

       ?column?       
----------------------
 production_tasks: 23
(1 row)

   ?column?    
---------------
 products: 273
(1 row)

  ?column?  
------------
 stock: 273
(1 row)

       ?column?        
-----------------------
 stock_movements: 1074
(1 row)

