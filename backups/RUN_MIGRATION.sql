-- ==============================================
-- МАСТЕР-СКРИПТ МИГРАЦИИ PRODUCTION БД
-- Дата: 23.10.2025
-- Описание: Добавление поддержки Liberty Grade
-- ==============================================

\echo ''
\echo '╔══════════════════════════════════════════════════════════════╗'
\echo '║     МИГРАЦИЯ PRODUCTION БД - LIBERTY GRADE SUPPORT           ║'
\echo '╚══════════════════════════════════════════════════════════════╝'
\echo ''
\echo 'Эта миграция добавит:'
\echo '  1. Поля Liberty в операции резки'
\echo '  2. Поля сортов в производственные задания'
\echo '  3. Обновленный триггер с поддержкой Liberty'
\echo ''
\echo 'Бэкап уже создан в:'
\echo '  - cutting_operations_backup_20251023'
\echo '  - cutting_progress_log_backup_20251023'
\echo '  - production_tasks_backup_20251023'
\echo '  - products_grades_backup_20251023'
\echo '  - stock_grades_backup_20251023'
\echo ''
\echo 'Ожидаемое время: ~30 секунд'
\echo ''

\prompt 'Продолжить миграцию? (yes/no): ' confirmation

\if :confirmation = 'yes'
    \echo ''
    \echo '═══════════════════════════════════════════════════════════════'
    \echo '  МИГРАЦИЯ 1/3: Добавление полей Liberty в операции резки'
    \echo '═══════════════════════════════════════════════════════════════'
    \echo ''
    
    \i 01_add_liberty_grade_fields.sql
    
    \echo ''
    \echo '═══════════════════════════════════════════════════════════════'
    \echo '  МИГРАЦИЯ 2/3: Добавление полей сортов в production_tasks'
    \echo '═══════════════════════════════════════════════════════════════'
    \echo ''
    
    \i 02_add_production_grades_fields.sql
    
    \echo ''
    \echo '═══════════════════════════════════════════════════════════════'
    \echo '  МИГРАЦИЯ 3/3: Обновление триггера для Liberty'
    \echo '═══════════════════════════════════════════════════════════════'
    \echo ''
    
    \i 03_update_cutting_progress_trigger.sql
    
    \echo ''
    \echo '═══════════════════════════════════════════════════════════════'
    \echo '  ПРОВЕРКА МИГРАЦИИ'
    \echo '═══════════════════════════════════════════════════════════════'
    \echo ''
    
    \i 04_verify_migration.sql
    
    \echo ''
    \echo '╔══════════════════════════════════════════════════════════════╗'
    \echo '║                  МИГРАЦИЯ ЗАВЕРШЕНА!                         ║'
    \echo '╚══════════════════════════════════════════════════════════════╝'
    \echo ''
    \echo '✅ Все миграции выполнены успешно!'
    \echo ''
    \echo 'СЛЕДУЮЩИЕ ШАГИ:'
    \echo '  1. Проверьте результаты выше'
    \echo '  2. Задеплойте новую версию backend из ветки stage'
    \echo '  3. Задеплойте новую версию frontend из ветки stage'
    \echo '  4. Протестируйте операции резки с Liberty'
    \echo '  5. Протестируйте производственные задания с 2-м сортом и Liberty'
    \echo ''
    \echo 'В случае проблем:'
    \echo '  - Запустите ROLLBACK.sql для отката'
    \echo '  - Проверьте логи Railway'
    \echo '  - Обратитесь к MIGRATION_PLAN.md'
    \echo ''
\else
    \echo ''
    \echo 'Миграция отменена.'
    \echo ''
\endif




