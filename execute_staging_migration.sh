#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –≥–∏–±–∫–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Å—Ç–µ–π–¥–∂–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./execute_staging_migration.sh

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –≥–∏–±–∫–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –Ω–∞ —Å—Ç–µ–π–¥–∂–µ..."

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å—Ç–µ–π–¥–∂—É
STAGING_DB_URL="postgresql://postgres:pTMtLhlEmgeRAtUlFvGBhAYLNIlMkhwL@tramway.proxy.rlwy.net:50363/railway"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
echo "üì° –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–µ–π–¥–∂–∞..."
if ! psql "$STAGING_DB_URL" -c "SELECT 1;" > /dev/null 2>&1; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–µ–π–¥–∂–∞!"
    exit 1
fi

echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ!"

# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π
echo "üíæ –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π..."
BACKUP_FILE="production_backup_$(date +%Y%m%d_%H%M%S).sql"
pg_dump "$STAGING_DB_URL" > "$BACKUP_FILE"
echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_FILE"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã production_tasks..."
psql "$STAGING_DB_URL" -c "
SELECT 
  COUNT(*) as total_tasks,
  COUNT(planned_date) as tasks_with_planned_date,
  COUNT(planned_start_time) as tasks_with_planned_time
FROM production_tasks;
"

# –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é
echo "üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é..."
if psql "$STAGING_DB_URL" -f backend/migrations/add_flexible_production_planning.sql; then
    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏!"
    echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –±—ç–∫–∞–ø–∞..."
    psql "$STAGING_DB_URL" < "$BACKUP_FILE"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏..."
psql "$STAGING_DB_URL" -c "
SELECT 
  COUNT(*) as total_tasks,
  COUNT(planned_start_date) as tasks_with_start_date,
  COUNT(planned_end_date) as tasks_with_end_date,
  COUNT(estimated_duration_days) as tasks_with_duration,
  COUNT(CASE WHEN is_flexible = true THEN 1 END) as flexible_tasks,
  COUNT(CASE WHEN planning_status = 'confirmed' THEN 1 END) as confirmed_tasks
FROM production_tasks;
"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏..."
psql "$STAGING_DB_URL" -c "
SELECT 
  routine_name,
  routine_type
FROM information_schema.routines 
WHERE routine_name LIKE '%planning%' 
   OR routine_name LIKE '%production%';
"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è..."
psql "$STAGING_DB_URL" -c "
SELECT table_name 
FROM information_schema.views 
WHERE table_name LIKE '%production%';
"

# –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è..."
psql "$STAGING_DB_URL" -c "
SELECT get_production_planning_stats() as planning_stats;
"

echo "üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –≥–∏–±–∫–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
echo "   - –ë—ç–∫–∞–ø: $BACKUP_FILE"
echo "   - –ù–æ–≤—ã–µ –ø–æ–ª—è: planned_start_date, planned_end_date, estimated_duration_days"
echo "   - –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: validate_production_planning, check_production_overlaps"
echo "   - –ù–æ–≤—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è: production_tasks_with_planning"
echo "   - –ù–æ–≤—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã: tr_production_tasks_validate_planning"
